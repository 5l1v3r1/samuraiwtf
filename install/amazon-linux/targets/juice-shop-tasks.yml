- name: Check if Juice Shop tasks have already run
  stat:
    path: /tmp/juiceshop.latest
  register: stat_juiceshop_latest

- name: Get the latest release page of Juice Shop
  get_url:
    url: https://github.com/bkimminich/juice-shop/releases/latest
    dest: /tmp/juiceshop.latest

- name: Create script for finding juice shop version
  copy:
    dest: /tmp/juice_version.sh
    content: |
      #!/usr/bin/sh
      grep node10_linux_x64.tgz /tmp/juiceshop.latest | grep node10_linux_x64.tgz | grep href | cut -d '"' -f 2
    mode: 0744

- name: Get the path to the latest release of Juice Shop
  command: "/tmp/juice_version.sh"
  register: juiceshop_path
  become: yes

- debug:
    var: juiceshop_path

- name: Download and install Juice Shop app
  unarchive:
    src: "https://github.com{{ juiceshop_path.stdout }}"
    dest: /opt/targets/
    remote_src: yes

- name: Script to start juice shop
  copy:
    dest: /usr/local/bin/start_juice-shop.sh
    content: |
      #!/bin/bash

      export JUICE_SHOP_PATH=$(find /opt/targets/ -name 'juice-shop_*')
      cd $JUICE_SHOP_PATH
      sudo npm start &
    mode: 0744
    force: no
  become: yes

- name: Create service descriptor for wtf-juice-shop
  copy:
    dest: /etc/systemd/system/wtf-juice-shop.service
    content: |
      [Unit]
      Description=Juice Shop Target service
      [Service]
      Type=forking
      ExecStart=/usr/local/bin/start_juice-shop.sh
      [Install]
      WantedBy=multi-user.target
    mode: 0744
  become: yes

- name: Start Juice-Shop
  service:
    name: wtf-juice-shop.service
    state: started
    enabled: yes
  become: yes

- name: Setup hosts file entries
  lineinfile:
    dest: /etc/hosts
    line: '127.0.0.1   juice-shop.wtf'
  become: yes

- name: Setup nginx reverse-proxy config
  copy:
    dest: /etc/nginx/conf.d/juice-shop.conf
    content: |
      server {
        listen 80;
        server_name juice-shop.wtf;
        location / {
          proxy_pass http://localhost:3000;
        }
      }
    mode: 0644
  become: yes
  notify:
    - restart nginx

