---

- name: run the playbook tasks on the localhost from the ~/samuraiwtf folder
  hosts: 127.0.0.1
  connection: local
  tasks:

### Prerequisites

  - name: Check if nginx is already installed
    stat:
      path: /etc/nginx/nginx.conf
    register: stat_nginx_conf

  - name: Install nginx
    command: "amazon-linux-extras install nginx1.12"
    become: yes
    when: stat_nginx_conf.stat.exists == False

  - name: ensure prerequisite packages are installed
    yum:
      name:
        - vim
        - curl
        - docker
        - unzip
        - python-pip
        - php-fpm
        - nano
    become: true

  - name: python prerequisite modules
    pip:
      name: "{{ modules }}"
    become: yes
    vars:
      modules:
      - docker

  - name: Check if docker-compose is already installed
    stat:
      path: /usr/bin/docker-compose
    register: stat_docker_compose

  - name: install docker-compose
    shell: 'curl -L https://github.com/docker/compose/releases/download/1.14.0/docker-compose-`uname -s`-`uname -m` > /usr/bin/docker-compose'
    become: yes
    when: stat_docker_compose.stat.exists == False 

  - name: set permissions for docker-compose
    file:
      path: /usr/bin/docker-compose
      mode: "+x"
    become: yes

  - name: create the main Samurai program folder
    file:
      path: /opt/samurai
      state: directory
      owner: "{{ lookup('env','USER') }}"
      group: "CORP\\domain users"
    become: yes

  - name: Copy Samurai icon
    copy:
      src: ../../config/samurai-icon.png
      dest: /opt/samurai/
    become: yes

### Menus

  - name: Setup menu /etc/samurai.d/desktop-directories
    file:
      path: /etc/samurai.d/desktop-directories/
      state: directory
    become: yes

  - name: Setup menu /etc/samurai.d/applications
    file:
      path: /etc/samurai.d/applications/
      state: directory
    become: yes

- name: Setup menu /etc/samurai.d/desktop-directories
  file:
    path: /etc/samurai.d/desktop-directories/
    state: directory
  become: yes

- name: Create main samurai-wtf menu
  copy:
    dest: /etc/samurai.d/desktop-directories/samuraiwtf.directory
    content: |
      [Desktop Entry]
      Type=Directory
      Name=Samurai WTF
      Icon=/opt/samurai/icons/samurai-icon.png
    mode: 0744
  become: yes

- name: Create applications-merged folder
  file:
    path: /etc/xdg/menus/applications-merged
    state: directory
  become: yes

- name: Create main samurai-wtf menu
  copy:
    dest: /etc/xdg/menus/applications-merged/samuraiwtf.menu
    content: |
      <!DOCTYPE Menu PUBLIC "-//freedesktop//DTD Menu 1.0//EN"
      "http://www.freedesktop.org/standards/menu-spec/menu-1.0.dtd">
      <Menu>
        <Name>Applications</Name> <!-- This is necessary for your directory to appear in the applications drop down -->
        <Menu> <!--app -->
          <Name>Samurai</Name>
          <AppDir>/etc/samurai.d/applications</AppDir>
          <DirectoryDir>/etc/samurai.d/desktop-directories</DirectoryDir>
          <Directory>samuraiwtf.directory</Directory>
          <Include>
            <Category>samuraiwtf</Category>
          </Include>
        </Menu> <!-- End app -->
      </Menu> <!-- End Applications -->
    mode: 0744
  become: yes

### Setup first-time login customizations
  - name: Copy desktop file somewhere we can use it
    copy:
      src: ../../config/samurai-background.png
      dest: /opt/samurai/samurai-background.png

  - name: Create first-time login setup script.
    copy:
      dest: /etc/profile.d/first_login.sh
      content: |
        #!/bin/bash
        
        if [ -e $HOME/.samurai ]
        then
          echo "already run first time scripts."
        else
          cd /etc/dconf
          /usr/bin/dconf write /org/mate/desktop/background/picture-filename "'/opt/samurai/samurai-background.png'"
          /usr/bin/dconf write /org/mate/desktop/background/picture-options "'stretched'"
          if [ ! -L ~/samurai ]; then
            ln -s /opt/samurai ~/samurai
          fi
          touch $HOME/.samurai
        fi
        cd $HOME
      mode: 0755
    become: yes

  - name: Copy bookmarks to somewhere we can use it
    copy:
      src: ../../config/home/bookmarks.html
      dest: /opt/samurai

### Update PHP Config
  - name: Update PHP listener
    replace:
      path: /etc/php-fpm.d/www.conf
      regexp: '^listen = 127.0.0.1.*'
      replace: 'listen = /var/run/php-fpm/php-fpm.sock'
    become: yes

  - name: Update PHP User
    replace:
      path: /etc/php-fpm.d/www.conf
      regexp: '^user = apache'
      replace: 'user = nginx'
    become: yes

  - name: Update PHP Group
    replace:
      path: /etc/php-fpm.d/www.conf
      regexp: '^group = apache'
      replace: 'group = nginx'
    become: yes

  - name: Add info.php test file
    copy:
      dest: /usr/share/nginx/html/info.php
      content: |
        <?php phpinfo(); ?>
      mode: 0644
      force: no
    become: yes

  - name: Install nginx configuration
    copy:
      src: ../../config/nginx/
      dest: /etc/nginx/conf.d/
      force: no
    become: yes

  - name: Start PHP Processor
    service:
      name: php-fpm
      state: started
      enabled: yes
    become: yes


  - name: Create service descriptor
    copy:
      dest: /etc/systemd/system/wtftargets.service
      content: |
        [Unit]
        Description=WTF Targets service
        After=systemd-user-sessions.service
        [Service]
        Type=forking
        ExecStart=/usr/local/bin/startup_targets.sh
      mode: 0744
    become: yes

  - name: Start nginx
    service:
      name: nginx
      state: started
      enabled: yes
    become: yes

### Install Tools
- name: Install tools
  import_playbook: tools.yml

### Install Targets
- name: Install targets
  import_playbook: targets.yml