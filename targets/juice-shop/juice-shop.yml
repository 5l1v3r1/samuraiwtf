- name: Check if Juice Shop tasks have already run
  stat:
    path: /tmp/juiceshop.latest
  register: stat_juiceshop_latest

- name: Get the latest release page of Juice Shop
  get_url:
    url: https://github.com/bkimminich/juice-shop/releases/latest
    dest: /tmp/juiceshop.latest
  when: stat_juiceshop_latest.stat.exists == False

- name: Create script for finding juice shop version
  copy:
    dest: /tmp/juice_version.sh
    content: |
      #!/bin/sh
      grep node8_linux_x64.tgz /tmp/juiceshop.latest | grep node8_linux_x64.tgz | grep href | cut -d '"' -f 2
    mode: 0744
  when: stat_juiceshop_latest.stat.exists == False

- name: Get the path to the latest release of Juice Shop
  command: "/tmp/juice_version.sh"
  register: juiceshop_path
  when: stat_juiceshop_latest.stat.exists == False

- name: Download and install Juice Shop app
  unarchive:
    src: "https://github.com{{ juiceshop_path.stdout }}"
    dest: /opt/targets/
    remote_src: yes
  become: yes
  when: stat_juiceshop_latest.stat.exists == False

- name: Script to start juice shop
  copy:
    dest: /usr/local/bin/
    src: ../../targets/juice-shop/start_juice-shop.sh
    mode: 0744
    force: no
  become: yes

- name: Create service descriptor for wtf-juice-shop
  copy:
    dest: /etc/systemd/system/wtf-juice-shop.service
    content: |
      [Unit]
      Description=Juice Shop Target service

      [Service]
      Type=forking
      ExecStart=/usr/local/bin/start_juice-shop.sh

      [Install]
      WantedBy=multi-user.target
    mode: 0744
  become: yes

- name: Start Juice-Shop
  service:
    name: wtf-juice-shop.service
    state: started
    enabled: yes
  become: yes

